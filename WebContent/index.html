<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PWA Map Services</title>
<link rel="apple-touch-icon" href="touch-icon-iphone.png">
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#d8e8c8" />
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<meta name="msapplication-TileImage" content="images/icons/icon-152x152">
<meta name="msapplication-TileColor" content="#ffffff">
<link rel="stylesheet" href="leaflet.css" />
<script src="leaflet.js"></script>
<script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>
<!-- <script>
	if (window.location.protocol === "http:"
			&& window.location.origin != "localhost") {
		location.href = location.href.replace("http://", "https://");
	}
	console.log(Notification.permission)
</script> -->
</head>
<body>
	<noscript>You need to enable JavaScript to run this app.</noscript>
	<h1>
		<img src='img/hdb.png' width="40"height"40"></img> PWA Map Carpark
		Prototype
	</h1>
	<!--Creates a Div for Map-->
	<div id='map' style='height: 100%;'></div>

	<script>
		//Initialize OneMap and select one style
		//The parameters are Div name,Map style(default,night grey,original),Zoom, Latitude, Longitude and Opacity
		var map = onemap.initializeMap('map', "default", 60, 1.3, 103.8, 0.8)
		map.locate({
			setView : true,
			maxZoom : 90
		});

		//Setup configuration for REST API Services (Your Access Token)
		//Our Documentation @  https://docs.onemap.sg
		onemap
				.config("eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjQzODEsInVzZXJfaWQiOjQzODEsImVtYWlsIjoic2hlcnlsLnllby4yMDE2QHNtdS5lZHUuc2ciLCJmb3JldmVyIjpmYWxzZSwiaXNzIjoiaHR0cDpcL1wvb20yLmRmZS5vbmVtYXAuc2dcL2FwaVwvdjJcL3VzZXJcL3Nlc3Npb24iLCJpYXQiOjE1ODg4MzExMTIsImV4cCI6MTU4OTI2MzExMiwibmJmIjoxNTg4ODMxMTEyLCJqdGkiOiI0MzcwMDdkOTA5NDM0ODhmNzZkZjlhNmI3ZDhlZGQzZCJ9.CV5lgfnEX6Ul2FpuWsXShIvIOX_tfbGKlL_pBgu2NWA");

		//Call Theme Services
		var themeObj = onemap.retrieveTheme("hdb_car_park_information");

		//Convert Themes that are Points into GeoJSON for overlaying
		var data = onemap.pointTheme2GeoJSON(themeObj);

		//Add GeoJSON to map
		var geojson = L.geoJSON(data, {
			onEachFeature : function(feature, layer) {
				layer.bindPopup('<h1>' + feature.properties.DESCRIPTION
						+ '</h1><p>Description: ' + feature.properties.NAME
						+ '</p>');
				//Sets Icon information
				var icon = L.icon({
					iconUrl : 'img/parking.png',
					iconSize : [ 20, 20 ]
				});
				layer.setIcon(icon)
			}
		});
		geojson.addTo(map);
		//Fit bound to markers
		map.fitBounds(geojson.getBounds());
		
		getLocation();
		function getLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(showPosition);
			}
		}

		function showPosition(position) {
			marker = new L.Marker([ position.coords.latitude,
					position.coords.longitude ], {
				bounceOnAdd : false
			}).addTo(map);
			var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
		    // This is making the Geocode request
		    var geocoder = new google.maps.Geocoder();
		    var address="";
		    var responseStatus=true;
		    geocoder.geocode({ 'latLng': latlng }, function (results, status) {
		        if (status !== google.maps.GeocoderStatus.OK) {
		            alert("Error:-"+status);
		            responseStatus=true;
		        }
		        // This is checking to see if the Geoeode Status is OK before proceeding
		        if (status == google.maps.GeocoderStatus.OK) {
		            console.log(results);
		            address = (results[0].formatted_address);
		        }
		    });
		    if(responseStatus){
		    	var popup = L.popup().setLatLng(
					[ position.coords.latitude, position.coords.longitude ])
					.setContent(address).openOn(map);
		    }else{
		    	var popup = L.popup().setLatLng(
						[ position.coords.latitude, position.coords.longitude ])
						.setContent("You are here!").openOn(map);
		    }
			
		}
		
	</script>
	<script type="text/javascript">
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('/sw.js').then(function() {
				console.log("Service Worker Registered");
			});
		}
	</script>

</body>
</html>