<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PWA Map Services</title>
<link rel="apple-touch-icon" href="touch-icon-iphone.png">
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#d8e8c8" />
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<meta name="msapplication-TileImage" content="images/icons/icon-152x152">
<meta name="msapplication-TileColor" content="#ffffff">
<link rel="stylesheet" href="leaflet.css" />
<script src="leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- <script>
	if (window.location.protocol === "http:"
			&& window.location.origin != "localhost") {
		location.href = location.href.replace("http://", "https://");
	}
	console.log(Notification.permission)
</script> -->
</head>
<body>
	<noscript>You need to enable JavaScript to run this app.</noscript>
	<h1>
		<img src='img/hdb.png' width="40"height"40"></img> PWA Map Carpark
		Prototype
	</h1>
	<!--Creates a Div for Map-->
	<div id='map' style='height: 100%;'></div>

	<script>
		//Initialize OneMap and select one style
		//The parameters are Div name,Map style(default,night grey,original),Zoom, Latitude, Longitude and Opacity
		var map = onemap.initializeMap('map', "default", 60, 1.3, 103.8, 0.8)
		map.locate({
			setView : true,
			maxZoom : 90
		});

		//Setup configuration for REST API Services (Your Access Token)
		//Our Documentation @  https://docs.onemap.sg
		onemap
				.config("eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjQzODEsInVzZXJfaWQiOjQzODEsImVtYWlsIjoic2hlcnlsLnllby4yMDE2QHNtdS5lZHUuc2ciLCJmb3JldmVyIjpmYWxzZSwiaXNzIjoiaHR0cDpcL1wvb20yLmRmZS5vbmVtYXAuc2dcL2FwaVwvdjJcL3VzZXJcL3Nlc3Npb24iLCJpYXQiOjE1ODg4MzExMTIsImV4cCI6MTU4OTI2MzExMiwibmJmIjoxNTg4ODMxMTEyLCJqdGkiOiI0MzcwMDdkOTA5NDM0ODhmNzZkZjlhNmI3ZDhlZGQzZCJ9.CV5lgfnEX6Ul2FpuWsXShIvIOX_tfbGKlL_pBgu2NWA");

		//Call Theme Services
		var themeObj = onemap.retrieveTheme("hdb_car_park_information");

		//Convert Themes that are Points into GeoJSON for overlaying
		var data = onemap.pointTheme2GeoJSON(themeObj);

		//Add GeoJSON to map
		var geojson = L.geoJSON(data, {
			onEachFeature : function(feature, layer) {
				layer.bindPopup('<h1>' + feature.properties.DESCRIPTION
						+ '</h1><p>Description: ' + feature.properties.NAME
						+ '</p>');
				//Sets Icon information
				var icon = L.icon({
					iconUrl : 'img/parking.png',
					iconSize : [ 20, 20 ]
				});
				layer.setIcon(icon)
			}
		});
		geojson.addTo(map);
		//Fit bound to markers
		map.fitBounds(geojson.getBounds());
		
		getLocation();
		function getLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(showPosition);
			}
		}

		function showPosition(position) {
			 marker = new L.Marker([ position.coords.latitude,
					position.coords.longitude ], {
				bounceOnAdd : false
			}).addTo(map);
			var lat=position.coords.latitude;
			var lng=position.coords.longitude;
	        $.ajax({
	        url: 'https://developers.onemap.sg/privateapi/commonsvc/revgeocode?location='+lat+','+lng+'&token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjQzODEsInVzZXJfaWQiOjQzODEsImVtYWlsIjoic2hlcnlsLnllby4yMDE2QHNtdS5lZHUuc2ciLCJmb3JldmVyIjpmYWxzZSwiaXNzIjoiaHR0cDpcL1wvb20yLmRmZS5vbmVtYXAuc2dcL2FwaVwvdjJcL3VzZXJcL3Nlc3Npb24iLCJpYXQiOjE1ODg4MzExMTIsImV4cCI6MTU4OTI2MzExMiwibmJmIjoxNTg4ODMxMTEyLCJqdGkiOiI0MzcwMDdkOTA5NDM0ODhmNzZkZjlhNmI3ZDhlZGQzZCJ9.CV5lgfnEX6Ul2FpuWsXShIvIOX_tfbGKlL_pBgu2NWA&buffer=100&addressType=all',
	        success: function(result){
				var buildName = result.GeocodeInfo[0].BUILDINGNAME;
				var block = result.GeocodeInfo[0].BLOCK;
				var road = result.GeocodeInfo[0].ROAD;
	        	var popup = L.popup().setLatLng(
						[ position.coords.latitude, position.coords.longitude ])
						.setContent(buildName+', '+block+', '+road).openOn(map);
	            }});
		}
		
	</script>
	<script type="text/javascript">
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('/sw.js').then(function() {
				console.log("Service Worker Registered");
			});
		}
	</script>

</body>
</html>